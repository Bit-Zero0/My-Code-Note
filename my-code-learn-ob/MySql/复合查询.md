主要学习多表查询

# 基本查询回顾
- 查询工资高于500或岗位为MANAGER的雇员，同时还要满足他们的姓名首字母为大写的J
```sql
select * from emp where (sal>500 or job='MANAGER') and ename like 'J%';
+--------+-------+---------+------+---------------------+---------+------+--------+
| empno  | ename | job     | mgr  | hiredate            | sal     | comm | deptno |
+--------+-------+---------+------+---------------------+---------+------+--------+
| 007566 | JONES | MANAGER | 7839 | 1981-04-02 00:00:00 | 2975.00 | NULL |     20 |
| 007900 | JAMES | CLERK   | 7698 | 1981-12-03 00:00:00 |  950.00 | NULL |     30 |
+--------+-------+---------+------+---------------------+---------+------+--------+
```

- 按照部门号升序而雇员的工资降序排序
```sql
select * from emp order by deptno, sal desc;
+--------+--------+-----------+------+---------------------+---------+---------+--------+
| empno  | ename  | job       | mgr  | hiredate            | sal     | comm    | deptno |
+--------+--------+-----------+------+---------------------+---------+---------+--------+
| 007839 | KING   | PRESIDENT | NULL | 1981-11-17 00:00:00 | 5000.00 |    NULL |     10 |
| 007782 | CLARK  | MANAGER   | 7839 | 1981-06-09 00:00:00 | 2450.00 |    NULL |     10 |
| 007934 | MILLER | CLERK     | 7782 | 1982-01-23 00:00:00 | 1300.00 |    NULL |     10 |
| 007788 | SCOTT  | ANALYST   | 7566 | 1987-04-19 00:00:00 | 3000.00 |    NULL |     20 |
| 007902 | FORD   | ANALYST   | 7566 | 1981-12-03 00:00:00 | 3000.00 |    NULL |     20 |
| 007566 | JONES  | MANAGER   | 7839 | 1981-04-02 00:00:00 | 2975.00 |    NULL |     20 |
| 007876 | ADAMS  | CLERK     | 7788 | 1987-05-23 00:00:00 | 1100.00 |    NULL |     20 |
| 007369 | SMITH  | CLERK     | 7902 | 1980-12-17 00:00:00 |  800.00 |    NULL |     20 |
| 007698 | BLAKE  | MANAGER   | 7839 | 1981-05-01 00:00:00 | 2850.00 |    NULL |     30 |
| 007499 | ALLEN  | SALESMAN  | 7698 | 1981-02-20 00:00:00 | 1600.00 |  300.00 |     30 |
| 007844 | TURNER | SALESMAN  | 7698 | 1981-09-08 00:00:00 | 1500.00 |    0.00 |     30 |
| 007521 | WARD   | SALESMAN  | 7698 | 1981-02-22 00:00:00 | 1250.00 |  500.00 |     30 |
| 007654 | MARTIN | SALESMAN  | 7698 | 1981-09-28 00:00:00 | 1250.00 | 1400.00 |     30 |
| 007900 | JAMES  | CLERK     | 7698 | 1981-12-03 00:00:00 |  950.00 |    NULL |     30 |
+--------+--------+-----------+------+---------------------+---------+---------+--------+
```

- 使用年薪进行降序排序
```sql
select ename, sal*12+ifnull(comm,0) as '年薪' from emp order by 年薪  desc;
+--------+----------+
| ename  | 年薪     |
+--------+----------+
| KING   | 60000.00 |
| SCOTT  | 36000.00 |
| FORD   | 36000.00 |
| JONES  | 35700.00 |
| BLAKE  | 34200.00 |
| CLARK  | 29400.00 |
| ALLEN  | 19500.00 |
| TURNER | 18000.00 |
| MARTIN | 16400.00 |
| MILLER | 15600.00 |
| WARD   | 15500.00 |
| ADAMS  | 13200.00 |
| JAMES  | 11400.00 |
| SMITH  |  9600.00 |
+--------+----------+
```

- 显示工资最高的员工的名字和工作岗位
```sql
select ename, job from emp where sal = (select max(sal) from emp);
+-------+-----------+
| ename | job       |
+-------+-----------+
| KING  | PRESIDENT |
+-------+-----------+

```

- 显示工资高于平均工资的员工信息
```sql
select ename, sal from emp where sal>(select avg(sal) from emp);
+-------+---------+
| ename | sal     |
+-------+---------+
| JONES | 2975.00 |
| BLAKE | 2850.00 |
| CLARK | 2450.00 |
| SCOTT | 3000.00 |
| KING  | 5000.00 |
| FORD  | 3000.00 |
+-------+---------+
```

- 显示每个部门的平均工资和最高工资
```sql
select deptno, format(avg(sal), 2) , max(sal) from emp group by deptno;
+--------+----------------------+----------+
| deptno | format(avg(sal) , 2) | max(sal) |
+--------+----------------------+----------+
|     20 | 2,175.00             |  3000.00 |
|     30 | 1,566.67             |  2850.00 |
|     10 | 2,916.67             |  5000.00 |
+--------+----------------------+----------+
```

- 显示平均工资低于2000的部门号和它的平均工资
```sql
select deptno, avg(sal) as avg_sal from emp group by deptno having avg_sal<2000;
+--------+-------------+
| deptno | avg_val     |
+--------+-------------+
|     30 | 1566.666667 |
+--------+-------------+
```

- 显示每种岗位的雇员总数，平均工资
```sql
select job,count(*), format(avg(sal),2) from emp group by job;
+-----------+----------+----------------------+
| job       | count(*) | format(avg(sal) , 2) |
+-----------+----------+----------------------+
| CLERK     |        4 | 1,037.50             |
| SALESMAN  |        4 | 1,400.00             |
| MANAGER   |        3 | 2,758.33             |
| ANALYST   |        2 | 3,000.00             |
| PRESIDENT |        1 | 5,000.00             |
+-----------+----------+----------------------+
```

# 多表查询
实际开发中往往数据来自不同的表，所以需要多表查询。本节我们用一个简单的公司管理系统，有三张表 
emp,DEPT,SALGRADE来演示如何进行多表查询。

案例：
**显示雇员名、雇员工资以及所在部门的名字因为上面的数据来自emp和dept表，因此要联合查询**
![[Pasted image 20221118225010.png]]

其实我们只要emp表中的deptno = dept表中的deptno字段的记录
```sql
select EMP.ename, EMP.sal, DEPT.dname from EMP, DEPT where EMP.deptno = DEPT.deptno;
```

- ==**显示部门号为10的部门名，员工名和工资**==
```sql
select dname , ename,sal  from emp , dept where emp.deptno=dept.deptno and dept.deptno=10;
+------------+--------+---------+
| dname      | ename  | sal     |
+------------+--------+---------+
| ACCOUNTING | CLARK  | 2450.00 |
| ACCOUNTING | KING   | 5000.00 |
| ACCOUNTING | MILLER | 1300.00 |
+------------+--------+---------+
```

- ==**显示各个员工的姓名，工资，及工资级别**==
```sql
 select ename , sal , grade from emp , salgrade where emp.sal between losal and hisal;
+--------+---------+-------+
| ename  | sal     | grade |
+--------+---------+-------+
| SMITH  |  800.00 |     1 |
| ALLEN  | 1600.00 |     3 |
| WARD   | 1250.00 |     2 |
| JONES  | 2975.00 |     4 |
| MARTIN | 1250.00 |     2 |
| BLAKE  | 2850.00 |     4 |
| CLARK  | 2450.00 |     4 |
| SCOTT  | 3000.00 |     4 |
| KING   | 5000.00 |     5 |
| TURNER | 1500.00 |     3 |
| ADAMS  | 1100.00 |     1 |
| JAMES  |  950.00 |     1 |
| FORD   | 3000.00 |     4 |
| MILLER | 1300.00 |     2 |
+--------+---------+-------+
```

# 自连接
自连接是指在同一张表连接查询 

## 案例：

### 显示员工FORD的上级领导的编号和姓名（mgr是员工领导的编号--empno）
- 使用的子查询：
```sql
select empno , ename from emp where emp.empno=(select mgr from emp where ename='FORD');
+--------+-------+
| empno  | ename |
+--------+-------+
| 007566 | JONES |
+--------+-------+
```

- 使用多表查询（自查询)
```sql
-- 使用到表的别名
--from emp leader, emp worker，给自己的表起别名，因为要先做笛卡尔积，所以别名可以先识别
select leader.empno , leader.ename from emp as leader , emp as worker where leader.empno=worker.mgr and worker.ename='FORD';
+--------+-------+
| empno  | ename |
+--------+-------+
| 007566 | JONES |
+--------+-------+

```