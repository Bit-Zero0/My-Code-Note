# TCP基本认识
## 什么是 TCP ？
TCP 是**面向连接的、可靠的、基于字节流**的传输层通信协议。
![[Pasted image 20221029170648.png]]
-   **面向连接**：一定是「一对一」才能连接，不能像 UDP 协议可以一个主机同时向多个主机发送消息，也就是一对多是无法做到的；
-   **可靠的**：无论的网络链路中出现了怎样的链路变化，TCP 都可以保证一个报文一定能够到达接收端；
-   **字节流**：用户消息通过 TCP 协议传输时，消息可能会被操作系统「分组」成多个的 TCP 报文，如果接收方的程序如果不知道「消息的边界」，是无法读出一个有效的用户消息的。并且 TCP 报文是「有序的」，当「前一个」TCP 报文没有收到的时候，即使它先收到了后面的 TCP 报文，那么也不能扔给应用层去处理，同时对「重复」的 TCP 报文会自动丢弃。


## TCP 头格式有哪些？
标注颜色的表示与本文关联比较大的字段
![[Pasted image 20221029170109.png]]

**序列号**：在建立连接时由计算机生成的随机数作为其初始值，通过 SYN 包传给接收端主机，每发送一次数据，就「累加」一次该「数据字节数」的大小。**用来解决网络包乱序问题。**

**确认应答号**：指下一次「期望」收到的数据的序列号，发送端收到这个确认应答以后可以认为在这个序号以前的数据都已经被正常接收。**用来解决丢包的问题。**

**控制位：**
-  _URG_: 紧急指针是否有效
-   _ACK_：该位为 `1` 时，「确认应答」的字段变为有效，TCP 规定除了最初建立连接时的 `SYN` 包之外该位必须设置为 `1` 。
-  _PSH_: 提示接收端应用程序立刻从TCP缓冲区把数据读走
-   _RST_：该位为 `1` 时，表示 TCP 连接中出现异常必须强制断开连接。
-   _SYN_：该位为 `1` 时，表示希望建立连接，并在其「序列号」的字段进行序列号初始值的设定。
-   _FIN_：该位为 `1` 时，表示今后不会再有数据发送，希望断开连接。当通信结束希望断开连接时，通信双方的主机之间就可以相互交换 `FIN` 位为 1 的 TCP 段。

 **窗口大小(16位)**：用来做流量控制

**校验和(16位)**: 发送端填充, CRC校验. 接收端校验不通过, 则认为数据有问题. 此处的检验和不光包含TCP首部, 也 
包含TCP数据部分.

**紧急指针(16位)**: 标识哪部分数据是紧急数据;

**40字节头部选项**: 暂时忽略;

## 为什么需要 TCP 协议？ TCP 工作在哪一层？
`IP` 层是「不可靠」的，它不保证网络包的交付、不保证网络包的按序交付、也不保证网络包中的数据的完整性。
![[Pasted image 20221029170528.png]]
如果需要保障网络数据包的可靠性，那么就需要由上层（传输层）的 `TCP` 协议来负责。

因为 TCP 是一个工作在**传输层**的**可靠**数据传输的服务，它能确保接收端接收的网络包是**无损坏、无间隔、非冗余和按序的。**

注意：[[UDP协议]] 也在传输层

## 什么是TCP连接
简单来说就是，**用于保证可靠性和流量控制维护的某些状态信息，这些信息的组合，包括Socket、序列号和窗口大小称为连接。**
![[Pasted image 20221029170949.png]]
所以我们可以知道，建立一个 TCP 连接是需要客户端与服务端端达成上述三个信息的共识。
-   **Socket**：由 IP 地址和端口号组成
-   **序列号**：用来解决乱序问题等
-   **窗口大小**：用来做流量控制

